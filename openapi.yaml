openapi: 3.1.1
info:
  title: API для сервера чата
  description: |
    API для сервера чата.
    Предоставляет эндпоинты для регистрации и входа, а также
    для управления сообщениями (отправка нового, изменение старых, получение новых непрочитанных)
  version: 0.0.1
  contact:
    email: usikov_andru@mail.ru
    name: Andrew Usikov
    url: https://t.me/CGSGAU3

servers:
- url: http://localhost:8080
  description: Сервер разработки

tags:
- name: system
  description: Получение информации о состоянии сервера
- name: auth
  description: Запросы, связанные с учетными записями пользователей

paths:
  /api/alive:
    get:
      tags:
      - system
      summary: Получение информации о сервере
      description: |
        Получает информацию о дате и времени запуска сервера и текущем времени на сервере.
        Возвращает сообщение с соответствующими полями.
      operationId: ifAlive
      responses:
        '200':
          description: Сообщение о состоянии сервера получено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AliveResponse'
  /api/check_token:
    post:
      tags:
      - system
      summary: Получение информации о статусе токена
      description: |
        Получает информацию о наличии отправленного токена в базе данных активных сессий.
        Возвращает JSON с одним полем - флагом наличия токена в базе.
      operationId: check_token
      requestBody:
        $ref: '#/components/requestBodies/TokenBody'
      responses:
        '200':
          description: Объект с флагом существования токена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenStatus'
        '400':
          description: Во время обработки запроса произошла ошибка
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
  /api/auth/register:
    post:
      tags:
      - auth
      summary: Запрос на регистрацию нового пользователя
      description: |
        Отправляет запрос на регистрацию со всеми заполненными полями.
        Возвращает статус запроса.
      operationId: register
      requestBody:
        $ref: '#/components/requestBodies/RegisterBody'
      responses:
        '200':
          description: Статус запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RawSuccess'
        '400':
          description: В данных содержится ошибка
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
  /api/auth/login:
    post:
      tags:
      - auth
      summary: Запрос на авторизацию пользователя
      description: |
        Отправляет запрос на авторизацию с заполненным логином и паролем.
        Возвращает статус запроса и токен авторизации.
      operationId: login
      requestBody:
        $ref: '#/components/requestBodies/LoginBody'
      responses:
        '200':
          description: Токен авторизации и статус
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Такого пользователя не существует или в данных иная ошибка
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '401':
          description: Пароль неверный
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '500':
          description: Произошла внутренняя ошибка сервера
  /api/auth/logout:
    post:
      tags:
      - auth
      summary: Выход пользователя из системы
      description: |
        Завершает сессию пользователя и удаляет токен авторизации.
        Требует заголовок Authorization-Token.
      operationId: logout
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      responses:
        '200':
          description: Выход выполнен успешно
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RawSuccess'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/users/me:
    get:
      tags:
      - users
      summary: Получение информации о текущем пользователе
      description: |
        Возвращает информацию о пользователе, соответствующем переданному токену.
        Требует заголовок Authorization-Token.
      operationId: getCurrentUser
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      responses:
        '200':
          description: Информация о пользователе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/users/online:
    get:
      tags:
      - users
      summary: Получение списка онлайн пользователей
      description: |
        Возвращает список пользователей, которые сейчас онлайн.
        Требует заголовок Authorization-Token.
      operationId: getOnlineUsers
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      responses:
        '200':
          description: Список онлайн пользователей
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OnlineUsersResponse'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/users/count:
    get:
      tags:
      - users
      summary: Получение общего количества пользователей
      description: |
        Возвращает общее количество зарегистрированных пользователей.
        Требует заголовок Authorization-Token.
      operationId: getUsersCount
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      responses:
        '200':
          description: Количество пользователей
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/messages:
    post:
      tags:
      - messages
      summary: Отправка нового сообщения
      description: |
        Отправляет новое сообщение в чат от имени текущего пользователя.
        Требует заголовок Authorization-Token.
      operationId: sendMessage
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - message_text
              properties:
                message_text:
                  type: string
                  description: Текст сообщения
              example:
                message_text: Привет, мир!
      responses:
        '200':
          description: Сообщение отправлено успешно
        '400':
          description: Ошибка в данных запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

    get:
      tags:
      - messages
      summary: Получение последних сообщений
      description: |
        Возвращает последние сообщения из чата.
        Требует заголовок Authorization-Token и параметр limit.
      operationId: getLastMessages
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      - name: limit
        in: query
        required: true
        schema:
          type: integer
          minimum: 1
        description: Количество возвращаемых сообщений
      responses:
        '200':
          description: Список сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'
        '400':
          description: Отсутствует параметр limit или ошибка в запросе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/messages/new:
    get:
      tags:
      - messages
      summary: Получение новых сообщений
      description: |
        Возвращает сообщения, отправленные после указанного ID.
        Требует заголовок Authorization-Token и параметр after_id.
      operationId: getNewMessages
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      - name: after_id
        in: query
        required: true
        schema:
          type: integer
          minimum: 0
        description: ID сообщения, после которого нужно вернуть новые сообщения
      responses:
        '200':
          description: Список новых сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'
        '400':
          description: Отсутствует параметр after_id или ошибка в запросе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'

  /api/messages/count:
    get:
      tags:
      - messages
      summary: Получение общего количества сообщений
      description: |
        Возвращает общее количество сообщений в чате.
        Требует заголовок Authorization-Token.
      operationId: getMessagesCount
      parameters:
      - name: Authorization-Token
        in: header
        required: true
        schema:
          type: string
        description: Токен авторизации
      responses:
        '200':
          description: Количество сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
        '401':
          description: Неверный или отсутствующий токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSchema'



components:
  requestBodies:
    TokenBody:
      required: true
      description: JSON с токеном, который надо проверить
      content:
        application/json:
          schema:
            type: object
            required:
            - token
            properties:
              token:
                type: string
                description: Токен, который надо проверить
            example:
              token: ABCDEFG

    RegisterBody:
      required: true
      description: Объект с заполненными данными пользователя
      content:
        application/json:
          schema:
            type: object
            required:
            - login
            - password
            - first_name
            - last_name
            properties:
              login:
                type: string
                description: Юзернейм пользователя
              password:
                type: string
                description: Пароль пользователя
              first_name:
                type: string
                description: Имя пользователя
              last_name:
                type: string
                description: Фамилия пользователя
            example:
              login: CGSGAU3
              password: qwerty
              first_name: Андрей
              last_name: Усиков
    
    LoginBody:
      required: true
      description: Объект с данными пользователя для авторизации
      content:
        application/json:
          schema:
            type: object
            required:
            - login
            - password
            properties:
              login:
                type: string
                description: Юзернейм пользователя
              password:
                type: string
                description: Пароль пользователя
            example:
              login: CGSGAU3
              password: qwerty


  schemas:
    AliveResponse:
      type: object
      required:
      - status
      - started_at
      - timestamp
      properties:
        status:
          type: string
          enum:
          - online
          description: Статус сервера
        started_at:
          type: string
          format: date-time
          description: Время запуска сервера
        timestamp:
          type: string
          format: date-time
          description: Локальное время на сервере
      example:
        status: online
        started_at: "2025-11-13 03:57:49"
        timestamp: "2025-11-13 04:19:08"

    TokenStatus:
      type: object
      required:
      - check_status
      properties:
        check_status:
          type: boolean
          description: Флаг существования токена в базе данных
      example:
        check_status: true

    RawSuccess:
      type: object
      request:
      - status
      properties:
        status:
          type: string
          enum:
          - success
          description: Статус запроса
      example:
        status: success

    LoginResponse:
      type: object
      request:
      - status
      - auth_token
      properties:
        status:
          type: string
          enum:
          - success
          description: Статус запроса
        auth_token:
          type: string
          description: Токен для последующих взаимодействий с api
      example:
        status: success
        token: ABCDEFG

    User:
      type: object
      properties:
        id:
          type: integer
          description: ID пользователя
        login:
          type: string
          description: Логин пользователя
        first_name:
          type: string
          description: Имя пользователя
        last_name:
          type: string
          description: Фамилия пользователя
        is_online:
          type: boolean
          description: Статус онлайн
      example:
        id: 1
        login: "CGSGAU3"
        first_name: "Андрей"
        last_name: "Усиков"
        is_online: true

    OnlineUsersResponse:
      type: object
      required:
      - total_online
      - online_users
      properties:
        total_online:
          type: integer
          description: Общее количество онлайн пользователей
        online_users:
          type: array
          items:
            $ref: '#/components/schemas/User'
          description: Список онлайн пользователей
      example:
        total_online: 3
        online_users:
          - id: 1
            login: "CGSGAU3"
            first_name: "Андрей"
            last_name: "Усиков"
            is_online: true
          - id: 2
            login: "user2"
            first_name: "Иван"
            last_name: "Петров"
            is_online: true

    Message:
      type: object
      required:
      - id
      - user_id
      - text
      - timestamp
      properties:
        id:
          type: integer
          description: ID сообщения
        user_id:
          type: integer
          description: ID пользователя, отправившего сообщение
        text:
          type: string
          description: Текст сообщения
        timestamp:
          type: string
          format: date-time
          description: Время отправки сообщения
        user_login:
          type: string
          description: Логин пользователя (опционально)
        user_first_name:
          type: string
          description: Имя пользователя (опционально)
        user_last_name:
          type: string
          description: Фамилия пользователя (опционально)
      example:
        id: 123
        user_id: 1
        text: "Привет, мир!"
        timestamp: "2025-11-13 04:19:08"
        user_login: "CGSGAU3"
        user_first_name: "Андрей"
        user_last_name: "Усиков"

    MessagesResponse:
      type: object
      required:
      - total_count
      - messages
      properties:
        total_count:
          type: integer
          description: Общее количество возвращенных сообщений
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Список сообщений
      example:
        total_count: 2
        messages:
          - id: 123
            user_id: 1
            text: "Привет, мир!"
            timestamp: "2025-11-13 04:19:08"
            user_login: "CGSGAU3"
            user_first_name: "Андрей"
            user_last_name: "Усиков"
          - id: 124
            user_id: 2
            text: "Привет!"
            timestamp: "2025-11-13 04:20:15"
            user_login: "user2"
            user_first_name: "Иван"
            user_last_name: "Петров"

    CountResponse:
      type: object
      required:
      - status
      - count
      properties:
        status:
          type: string
          enum:
          - success
          description: Статус запроса
        count:
          type: integer
          description: Количество элементов
      example:
        status: success
        count: 42

    ErrorSchema:
      type: object
      required:
      - status
      - error
      - message
      properties:
        status:
          type: string
          enum:
          - error
          description: Статус запроса
        error:
          type: string
          description: Название ошибки в HTTP-формулировке
        message:
          type: string
          description: Сообщение ошибки
      example:
        status: error
        error: bad_request
        message: Exception while processing request!
          
